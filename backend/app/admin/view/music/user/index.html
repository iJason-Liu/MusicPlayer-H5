<div class="layuimini-container">
    <div class="layuimini-main">
        <div class="layui-card">
            <div class="layui-card-header">用户管理</div>
            <div class="layui-card-body">
                <table class="layui-hide" id="dataTable" lay-filter="dataTable"></table>
            </div>
        </div>
    </div>
</div>

<script type="text/html" id="toolbar">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="add">
            <i class="layui-icon layui-icon-add-1"></i> 添加用户
        </button>
        <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="del">
            <i class="layui-icon layui-icon-delete"></i> 批量删除
        </button>
    </div>
</script>

<script type="text/html" id="statusTpl">
    <input type="checkbox" name="status" value="{{d.id}}" lay-skin="switch" lay-text="正常|禁用" lay-filter="status" {{ d.status==1 ? 'checked' : '' }}>
</script>

<script type="text/html" id="barTpl">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="resetPwd">重置密码</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">删除</a>
</script>

<script>
layui.use(['table', 'form', 'layer'], function(){
    var table = layui.table;
    var form = layui.form;
    var layer = layui.layer;
    var $ = layui.$;
    
    // 渲染表格
    table.render({
        elem: '#dataTable',
        url: '{:url("index")}',
        toolbar: '#toolbar',
        defaultToolbar: ['filter', 'print', 'exports'],
        cols: [[
            {type: 'checkbox', fixed: 'left'},
            {field: 'id', title: 'ID', width: 80, sort: true},
            {field: 'avatar', title: '头像', width: 80, templet: function(d){
                if(d.avatar){
                    return '<img src="' + d.avatar + '" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">';
                }
                return '<div style="width: 40px; height: 40px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; color: #999;">无</div>';
            }},
            {field: 'username', title: '用户名', width: 150},
            {field: 'nickname', title: '昵称', width: 150},
            {field: 'email', title: '邮箱', width: 180},
            {field: 'mobile', title: '手机号', width: 130},
            {field: 'play_count', title: '播放次数', width: 110, sort: true},
            {field: 'favorite_count', title: '收藏数', width: 110, sort: true},
            {field: 'playlist_count', title: '播放列表', width: 110, sort: true},
            {field: 'status', title: '状态', width: 100, templet: '#statusTpl', unresize: true},
            {field: 'create_time', title: '创建时间', width: 180, sort: true},
            {fixed: 'right', title: '操作', width: 240, toolbar: '#barTpl'}
        ]],
        page: true,
        limits: [10, 20, 50, 100],
        limit: 20
    });
    
    // 头工具栏事件
    table.on('toolbar(dataTable)', function(obj){
        var checkStatus = table.checkStatus(obj.config.id);
        switch(obj.event){
            case 'add':
                layer.open({
                    type: 2,
                    title: '添加用户',
                    content: '{:url("add")}',
                    area: ['600px', '500px'],
                    end: function(){
                        table.reload('dataTable');
                    }
                });
                break;
            case 'del':
                var data = checkStatus.data;
                if(data.length === 0){
                    layer.msg('请选择要删除的数据');
                    return;
                }
                var ids = data.map(function(item){
                    return item.id;
                }).join(',');
                layer.confirm('确定要删除选中的用户吗？', function(index){
                    $.post('{:url("delete")}', {id: ids}, function(res){
                        if(res.code == 1){
                            layer.msg(res.msg, {icon: 1});
                            table.reload('dataTable');
                        } else {
                            layer.msg(res.msg, {icon: 2});
                        }
                    });
                    layer.close(index);
                });
                break;
        }
    });
    
    // 监听行工具事件
    table.on('tool(dataTable)', function(obj){
        var data = obj.data;
        if(obj.event === 'edit'){
            layer.open({
                type: 2,
                title: '编辑用户',
                content: '{:url("edit")}?id=' + data.id,
                area: ['600px', '500px'],
                end: function(){
                    table.reload('dataTable');
                }
            });
        } else if(obj.event === 'del'){
            layer.confirm('确定要删除该用户吗？', function(index){
                $.post('{:url("delete")}', {id: data.id}, function(res){
                    if(res.code == 1){
                        layer.msg(res.msg, {icon: 1});
                        obj.del();
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
                layer.close(index);
            });
        } else if(obj.event === 'resetPwd'){
            layer.prompt({title: '请输入新密码', formType: 1}, function(pass, index){
                $.post('{:url("resetPassword")}?ids=' + data.id, {password: pass}, function(res){
                    if(res.code == 1){
                        layer.msg(res.msg, {icon: 1});
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
                layer.close(index);
            });
        }
    });
    
    // 监听状态开关
    form.on('switch(status)', function(obj){
        var status = obj.elem.checked ? 1 : 0;
        $.post('{:url("changeStatus")}?ids=' + this.value, {status: status}, function(res){
            if(res.code == 1){
                layer.msg(res.msg, {icon: 1});
            } else {
                layer.msg(res.msg, {icon: 2});
                obj.elem.checked = !obj.elem.checked;
                form.render('checkbox');
            }
        });
    });
});
</script>
