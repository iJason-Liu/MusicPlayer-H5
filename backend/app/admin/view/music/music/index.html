<div class="layuimini-container">
    <div class="layuimini-main">
        <div class="layui-card">
            <div class="layui-card-header">éŸ³ä¹ç®¡ç†</div>
            <div class="layui-card-body"></div>
        <div class="layui-btn-group">
            <button class="layui-btn layui-btn-sm" id="btn-scan">
                <i class="fa fa-refresh"></i> æ‰«æéŸ³ä¹æ–‡ä»¶
            </button>
            <button class="layui-btn layui-btn-sm layui-btn-normal" id="btn-upload">
                <i class="fa fa-upload"></i> ä¸Šä¼ éŸ³ä¹
            </button>
            <button class="layui-btn layui-btn-sm layui-btn-warm" id="btn-match">
                <i class="fa fa-magic"></i> åŒ¹é…ä¿¡æ¯
            </button>
            <button class="layui-btn layui-btn-sm layui-btn-danger" id="btn-delete">
                <i class="fa fa-trash"></i> æ‰¹é‡åˆ é™¤
            </button>
        </div>
        
        <table id="dataTable" lay-filter="dataTable"></table>
    </div>
</div>

<script type="text/html" id="toolbar">
    <div class="layui-form">
        <div class="layui-inline">
            <input class="layui-input" name="name" placeholder="æ­Œæ›²åç§°" autocomplete="off">
        </div>
        <div class="layui-inline">
            <input class="layui-input" name="artist" placeholder="æ­Œæ‰‹" autocomplete="off">
        </div>
        <div class="layui-inline">
            <button class="layui-btn layui-btn-sm" lay-submit lay-filter="search">
                <i class="fa fa-search"></i> æœç´¢
            </button>
            <button class="layui-btn layui-btn-sm layui-btn-primary" type="reset">
                <i class="fa fa-refresh"></i> é‡ç½®
            </button>
        </div>
    </div>
</script>

<script type="text/html" id="statusTpl">
    {{# if(d.status == 1){ }}
        <span class="layui-badge layui-bg-green">æ­£å¸¸</span>
    {{# } else { }}
        <span class="layui-badge">ç¦ç”¨</span>
    {{# } }}
</script>

<script type="text/html" id="coverTpl">
    {{# if(d.cover){ }}
        <img src="{{d.cover}}" style="max-width:45px;max-height:40px;border-radius:4px;">
    {{# } else { }}
        <span class="layui-badge layui-bg-gray">æ— å°é¢</span>
    {{# } }}
</script>

<script type="text/html" id="operateTpl">
    <a class="layui-btn layui-btn-xs layui-btn-normal play-btn" lay-event="play" data-id="{{d.id}}" title="æ’­æ”¾">
        <i class="fa fa-play"></i>
    </a>
    <a class="layui-btn layui-btn-xs" lay-event="supplement">è¡¥å……</a>
    <a class="layui-btn layui-btn-xs" lay-event="edit">ç¼–è¾‘</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">åˆ é™¤</a>
</script>

<script>
layui.use(['table', 'form', 'layer'], function(){
    var table = layui.table;
    var form = layui.form;
    var layer = layui.layer;
    var $ = layui.$;
    
    // æ¸²æŸ“è¡¨æ ¼
    var tableIns = table.render({
        elem: '#dataTable',
        url: '{:url("index")}',
        toolbar: '#toolbar',
        defaultToolbar: ['filter', 'exports', 'print'],
        cols: [[
            {type: 'checkbox', fixed: 'left'},
            {field: 'id', title: 'ID', width: 80, sort: true},
            {field: 'cover', title: 'å°é¢', width: 80, templet: '#coverTpl'},
            {field: 'name', title: 'æ­Œæ›²åç§°', minWidth: 150},
            {field: 'artist', title: 'æ­Œæ‰‹', width: 150},
            {field: 'album', title: 'ä¸“è¾‘', width: 150},
            {field: 'duration', title: 'æ—¶é•¿', width: 100},
            {field: 'size', title: 'æ–‡ä»¶å¤§å°', width: 110, sort: true},
            {field: 'status', title: 'çŠ¶æ€', width: 100, templet: '#statusTpl'},
            {field: 'create_time', title: 'åˆ›å»ºæ—¶é—´', width: 170, sort: true},
            {title: 'æ“ä½œ', width: 240, fixed: 'right', toolbar: '#operateTpl'}
        ]],
        page: true,
        limit: 20,
        limits: [10, 20, 50, 100]
    });
    
    // æœç´¢
    form.on('submit(search)', function(data){
        var field = data.field;
        var filter = {};
        var op = {};
        
        // æ„å»ºæœç´¢å‚æ•°
        if(field.name){
            filter.name = field.name;
            op.name = '%*%';  // æ¨¡ç³Šæœç´¢
        }
        if(field.artist){
            filter.artist = field.artist;
            op.artist = '%*%';  // æ¨¡ç³Šæœç´¢
        }
        
        tableIns.reload({
            where: {
                filter: JSON.stringify(filter),
                op: JSON.stringify(op)
            },
            page: {curr: 1}
        });
        return false;
    });
    
    // é‡ç½®æœç´¢
    $('.layui-btn-primary[type="reset"]').click(function(){
        tableIns.reload({
            where: {},
            page: {curr: 1}
        });
    });
    
    // ç›‘å¬è¾“å…¥æ¡†å›è½¦äº‹ä»¶
    $('#toolbar input').on('keydown', function(e){
        if(e.keyCode === 13){
            e.preventDefault();
            $('button[lay-filter="search"]').trigger('click');
        }
    });
    
    // æ‰«æéŸ³ä¹æ–‡ä»¶
    $('#btn-scan').click(function(){
        layer.confirm('ç¡®å®šè¦æ‰«æéŸ³ä¹ç›®å½•å—ï¼Ÿ', function(index){
            layer.close(index);
            layer.load(1);
            $.post('{:url("scan")}', {}, function(res){
                layer.closeAll('loading');
                if(res.code == 1){
                    layer.msg(res.msg, {icon: 1});
                    tableIns.reload();
                } else {
                    layer.msg(res.msg, {icon: 2});
                }
            });
        });
    });
    
    // ä¸Šä¼ éŸ³ä¹
    $('#btn-upload').click(function(){
        layer.open({
            type: 2,
            title: 'ä¸Šä¼ éŸ³ä¹',
            area: ['750px', '480px'],
            content: '{:url("add")}'
        });
    });
    
    // åŒ¹é…ä¿¡æ¯
    $('#btn-match').click(function(){
        var checkStatus = table.checkStatus('dataTable');
        var data = checkStatus.data;
        
        if(data.length === 0){
            layer.msg('è¯·é€‰æ‹©è¦åŒ¹é…çš„éŸ³ä¹', {icon: 0});
            return;
        }
        
        var ids = data.map(function(item){ return item.id; }).join(',');
        
        layer.confirm('ç¡®å®šè¦åŒ¹é…é€‰ä¸­çš„ ' + data.length + ' é¦–æ­Œæ›²ä¿¡æ¯å—ï¼Ÿ', function(index){
            layer.close(index);
            layer.load(1);
            $.post('{:url("match")}', {ids: ids}, function(res){
                layer.closeAll('loading');
                if(res.code == 1){
                    layer.msg(res.msg, {icon: 1});
                    tableIns.reload();
                } else {
                    layer.msg(res.msg, {icon: 2});
                }
            });
        });
    });
    
    // æ‰¹é‡åˆ é™¤
    $('#btn-delete').click(function(){
        var checkStatus = table.checkStatus('dataTable');
        var data = checkStatus.data;
        
        if(data.length === 0){
            layer.msg('è¯·é€‰æ‹©è¦åˆ é™¤çš„éŸ³ä¹', {icon: 0});
            return;
        }
        
        var ids = data.map(function(item){ return item.id; }).join(',');
        
        layer.confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ' + data.length + ' é¦–æ­Œæ›²å—ï¼Ÿ', function(index){
            layer.close(index);
            $.post('{:url("delete")}', {id: ids}, function(res){
                if(res.code == 1){
                    layer.msg(res.msg, {icon: 1});
                    tableIns.reload();
                } else {
                    layer.msg(res.msg, {icon: 2});
                }
            });
        });
    });
    
    // å·¥å…·æ äº‹ä»¶
    table.on('tool(dataTable)', function(obj){
        var data = obj.data;
        
        if(obj.event === 'play'){
            // æ’­æ”¾éŸ³ä¹
            playMusic(data);
        } else if(obj.event === 'supplement'){
            // è¡¥å……ä¿¡æ¯
            showSupplementDialog(data);
        } else if(obj.event === 'edit'){
            layer.open({
                type: 2,
                title: 'ç¼–è¾‘éŸ³ä¹',
                area: ['800px', '600px'],
                content: '{:url("edit")}?id=' + data.id
            });
        } else if(obj.event === 'del'){
            layer.confirm('ç¡®å®šè¦åˆ é™¤è¿™é¦–æ­Œæ›²å—ï¼Ÿ', function(index){
                layer.close(index);
                $.post('{:url("delete")}', {id: data.id}, function(res){
                    if(res.code == 1){
                        layer.msg(res.msg, {icon: 1});
                        obj.del();
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
            });
        }
    });
    
    // è¡¥å……ä¿¡æ¯å¼¹çª—
    function showSupplementDialog(music) {
        var content = `
            <div style="padding: 20px;">
                <div class="layui-form">
                    <div class="layui-form-item">
                        <label class="layui-form-label">å½“å‰æ­Œæ›²</label>
                        <div class="layui-input-block">
                            <input type="text" class="layui-input" value="${music.name || ''} - ${music.artist || ''}" disabled>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">æœç´¢å…³é”®è¯</label>
                        <div class="layui-input-block">
                            <div class="layui-input-group">
                                <input type="text" id="search-keywords" class="layui-input" placeholder="è¾“å…¥æ­Œæ›²åæˆ–æ­Œæ‰‹å" value="${music.name || ''}">
                                <div class="layui-input-split layui-input-suffix" style="cursor: pointer;" onclick="searchMusic()">
                                    <i class="layui-icon layui-icon-search"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="search-results" style="margin-top: 20px; max-height: 400px; overflow-y: auto;">
                    <div style="text-align: center; color: #999; padding: 40px 0;">
                        è¯·è¾“å…¥å…³é”®è¯æœç´¢æ­Œæ›²
                    </div>
                </div>
            </div>
        `;
        
        var layerIndex = layer.open({
            type: 1,
            title: 'è¡¥å……æ­Œæ›²ä¿¡æ¯',
            area: ['800px', '600px'],
            content: content,
            success: function() {
                // å›è½¦æœç´¢
                $('#search-keywords').on('keydown', function(e) {
                    if(e.keyCode === 13) {
                        searchMusic();
                    }
                });
                
                // å…¨å±€æœç´¢å‡½æ•°
                window.searchMusic = function() {
                    var keywords = $('#search-keywords').val().trim();
                    if(!keywords) {
                        layer.msg('è¯·è¾“å…¥æœç´¢å…³é”®è¯', {icon: 0});
                        return;
                    }
                    
                    $('#search-results').html('<div style="text-align: center; padding: 40px 0;"><i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> æœç´¢ä¸­...</div>');
                    
                    $.get('{:url("searchFromApi")}', {keywords: keywords}, function(res) {
                        if(res.code == 1 && res.data && res.data.length > 0) {
                            renderSearchResults(res.data, music.id);
                        } else {
                            $('#search-results').html('<div style="text-align: center; color: #999; padding: 40px 0;">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</div>');
                        }
                    }).fail(function() {
                        $('#search-results').html('<div style="text-align: center; color: #ff5722; padding: 40px 0;">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</div>');
                    });
                };
                
                // æ¸²æŸ“æœç´¢ç»“æœ
                window.renderSearchResults = function(songs, musicId) {
                    var html = '<div class="layui-card">';
                    
                    songs.forEach(function(song, index) {
                        var artists = song.artists ? song.artists.map(function(a) { return a.name; }).join('/') : '';
                        var albumName = song.album ? song.album.name : '';
                        var coverUrl = song.album && song.album.img1v1Url ? song.album.img1v1Url : '';
                        var duration = song.duration ? Math.floor(song.duration / 1000) : 0;
                        var durationStr = Math.floor(duration / 60) + ':' + String(duration % 60).padStart(2, '0');
                        var songId = song.id || 0;
                        var coverId = 'cover-' + index;
                        
                        html += '<div class="layui-card-body" style="border-bottom: 1px solid #f0f0f0; padding: 15px; cursor: pointer;" onmouseover="this.style.backgroundColor=\'#f8f8f8\'" onmouseout="this.style.backgroundColor=\'#fff\'" onclick="applySupplement(' + musicId + ', ' + songId + ', \'' + song.name.replace(/'/g, "\\'") + '\')">';
                        html += '<div style="display: flex; align-items: center;">';
                        
                        // å°é¢å®¹å™¨
                        html += '<div id="' + coverId + '" style="width: 60px; height: 60px; border-radius: 4px; margin-right: 15px; overflow: hidden; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">';
                        if(coverUrl) {
                            // æ·»åŠ  referrerpolicy å’Œé”™è¯¯å¤„ç†
                            html += '<img src="' + coverUrl + '" referrerpolicy="no-referrer" crossorigin="anonymous" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display=\'none\'; this.parentElement.innerHTML=\'<i class=\\\'layui-icon layui-icon-music\\\' style=\\\'font-size: 24px; color: #ccc;\\\'></i>\';">';
                        } else {
                            html += '<i class="layui-icon layui-icon-music" style="font-size: 24px; color: #ccc;"></i>';
                        }
                        html += '</div>';
                        
                        html += '<div style="flex: 1;">';
                        html += '<div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">' + song.name + '</div>';
                        html += '<div style="color: #999; font-size: 13px;">';
                        html += '<span>' + artists + '</span>';
                        if(albumName) {
                            html += ' Â· <span>' + albumName + '</span>';
                        }
                        html += ' Â· <span>' + durationStr + '</span>';
                        html += '</div>';
                        html += '</div>';
                        
                        html += '<div><button class="layui-btn layui-btn-sm layui-btn-normal">é€‰æ‹©</button></div>';
                        html += '</div>';
                        html += '</div>';
                    });
                    
                    html += '</div>';
                    $('#search-results').html(html);
                };
                
                // åº”ç”¨è¡¥å……ä¿¡æ¯
                window.applySupplement = function(musicId, songId, songName) {
                    layer.confirm('ç¡®å®šè¦åº”ç”¨ã€Š' + songName + 'ã€‹çš„ä¿¡æ¯å—ï¼Ÿ<br><br>å°†ä¼šè·å–ï¼š<br>â€¢ æ­Œæ›²è¯¦æƒ…ï¼ˆå°é¢ã€æ­Œæ‰‹ã€ä¸“è¾‘ã€æ—¶é•¿ï¼‰<br>â€¢ æ­Œè¯ä¿¡æ¯', {icon: 3}, function(confirmIndex) {
                        layer.close(confirmIndex);
                        
                        var loadIndex = layer.msg('æ­£åœ¨è·å–æ­Œæ›²è¯¦æƒ…å’Œæ­Œè¯...', {
                            icon: 16,
                            shade: 0.3,
                            time: 0
                        });
                        
                        $.post('{:url("applySupplement")}', {
                            music_id: musicId,
                            song_id: songId
                        }, function(res) {
                            layer.close(loadIndex);
                            if(res.code == 1) {
                                var msg = res.msg;
                                if(res.data && res.data.details && res.data.details.length > 0) {
                                    msg += '<br><br>ğŸ‘‡ğŸ»æ›´æ–°å†…å®¹ğŸ‘‡ğŸ»<br>' + res.data.details.join('<br>');
                                }
                                layer.alert(msg, {icon: 1}, function(alertIndex) {
                                    layer.close(alertIndex);
                                    layer.close(layerIndex);
                                    tableIns.reload();
                                });
                            } else {
                                layer.msg(res.msg, {icon: 2, time: 3000});
                            }
                        }).fail(function() {
                            layer.close(loadIndex);
                            layer.msg('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', {icon: 2});
                        });
                    });
                };
            }
        });
    }
    
    // æ’­æ”¾éŸ³ä¹åŠŸèƒ½
    var currentAudio = null;
    var currentPlayingId = null;
    
    // æ›´æ–°æ’­æ”¾æŒ‰é’®çŠ¶æ€
    function updatePlayButton(id, isPlaying) {
        // é‡ç½®æ‰€æœ‰æŒ‰é’®
        $('.play-btn').each(function() {
            $(this).removeClass('layui-btn-danger').addClass('layui-btn-normal');
            $(this).find('i').removeClass('fa-pause').addClass('fa-play');
            $(this).attr('title', 'æ’­æ”¾');
        });
        
        // æ›´æ–°å½“å‰æ’­æ”¾æŒ‰é’®
        if(isPlaying && id) {
            var btn = $('.play-btn[data-id="' + id + '"]');
            btn.removeClass('layui-btn-normal').addClass('layui-btn-danger');
            btn.find('i').removeClass('fa-play').addClass('fa-pause');
            btn.attr('title', 'æš‚åœ');
        }
    }
    
    function playMusic(data) {
        // æ„å»ºéŸ³ä¹ URL
        var musicUrl = 'https://diary.crayon.vip/Music/' + encodeURIComponent(data.file_path);
        
        // å¦‚æœæ­£åœ¨æ’­æ”¾åŒä¸€é¦–æ­Œï¼Œåˆ™æš‚åœ
        if(currentAudio && currentPlayingId === data.id) {
            if(currentAudio.paused) {
                currentAudio.play();
                updatePlayButton(data.id, true);
                layer.msg('ç»§ç»­æ’­æ”¾: ' + data.name, {icon: 1, time: 1500});
            } else {
                currentAudio.pause();
                updatePlayButton(data.id, false);
                layer.msg('å·²æš‚åœ', {icon: 0, time: 1000});
            }
            return;
        }
        
        // åœæ­¢ä¹‹å‰çš„æ’­æ”¾
        if(currentAudio) {
            currentAudio.pause();
            currentAudio = null;
            updatePlayButton(null, false);
        }
        
        // åˆ›å»ºæ–°çš„éŸ³é¢‘å¯¹è±¡
        currentAudio = new Audio(musicUrl);
        currentPlayingId = data.id;
        
        // æ’­æ”¾
        currentAudio.play().then(function() {
            updatePlayButton(data.id, true);
            layer.msg('æ­£åœ¨æ’­æ”¾: ' + data.name, {icon: 1, time: 1500});
        }).catch(function(error) {
            layer.msg('æ’­æ”¾å¤±è´¥: ' + error.message, {icon: 2});
            console.error('æ’­æ”¾å¤±è´¥:', error);
            currentPlayingId = null;
            updatePlayButton(null, false);
        });
        
        // æ’­æ”¾ç»“æŸäº‹ä»¶
        currentAudio.addEventListener('ended', function() {
            layer.msg('æ’­æ”¾å®Œæˆ', {icon: 1, time: 1000});
            currentPlayingId = null;
            updatePlayButton(null, false);
        });
        
        // é”™è¯¯äº‹ä»¶
        currentAudio.addEventListener('error', function(e) {
            layer.msg('æ’­æ”¾å‡ºé”™', {icon: 2});
            console.error('éŸ³é¢‘é”™è¯¯:', e);
            currentPlayingId = null;
            updatePlayButton(null, false);
        });
    }
});
</script>
    </div>
</div>
